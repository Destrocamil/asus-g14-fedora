#!/bin/bash

GPUFILE=/etc/asus_nvidia

if [ -f $GPUFILE ]; then
  echo "$GPUFILE exists."
  GPUFILEPRESENT=true
else
  echo "$GPUFILE does not exist."
  GPUFILEPRESENT=false
fi

if [[ $GPUFILEPRESENT == false ]]; then
  echo "set to Nvidia mode flag and restart GDM"
  systemctl stop gdm
  echo -n "0000:01:00.0" > /sys/bus/pci/drivers/nvidia/bind
  echo auto > /sys/bus/pci/devices/0000\:01\:00.0/power/control
  echo auto > /sys/bus/pci/devices/0000\:01\:00.1/power/control
  echo auto > /sys/bus/pci/devices/0000\:01\:00.2/power/control
  echo auto > /sys/bus/pci/devices/0000\:01\:00.3/power/control
  touch /etc/asus_nvidia
  asusctl -p normal
  systemctl restart gdm.service
else
  echo "deactivating nvidia"
  systemctl stop gdm
  echo -n "0000:01:00.0" > /sys/bus/pci/drivers/nvidia/unbind
  echo auto > /sys/bus/pci/devices/0000\:01\:00.0/power/control
  echo auto > /sys/bus/pci/devices/0000\:01\:00.1/power/control
  echo auto > /sys/bus/pci/devices/0000\:01\:00.2/power/control
  echo auto > /sys/bus/pci/devices/0000\:01\:00.3/power/control
  rm /etc/asus_nvidia
  asusctl -p silent
  systemctl restart gdm.service
fi
